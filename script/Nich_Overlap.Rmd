---
title: "Niche Models"
author: "Elke Hendrix"
date: "February 13, 2019"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction 
=============================
The following R markdown file explains the steps needed to calculate niche overlap between 154 Ungulates. Here we explain two different approaches to calculate the niche per species (i) Maxent species distribution models and (ii) Outlying Mean Index (OMI) and how to calculate their overlap. 

The following libraries need to be loaded: 

```{r, warnings=FALSE, message=FALSE, results='hide'}
library(raster)
library(knitr)
library(maxent)
library(maps)
library(rJava) 
library(maptools)
library(jsonlite)
library(caret)
library(ENMeval)
library(repmis)
library(CoordinateCleaner)
library(dismo) 
library(virtualspecies)
library(sp)
library(rgeos)
library(ape)
library(adehabitatMA)
library(ade4)
library(raster)
library(SDMTools)
library(factoextra)
library(ecospat)

```

To calculate niches and niche overlap environmental data and occurrence data per species are needed. 

The environmental data used in this research are based on climatic variables, topography and soil characteristics.  Climatic information about the present was subtracted from the widely used Bioclim dataset which includes 19 bioclimatic datasets. The datasets contain information such as precipitation in the driest quarter or maximum temperatures of the coldest month and are constructed based on monthly remote sensing data between 1950 and 2000 (Hijmans et al., 2005, Title et al ., 2018). The dataset can directly be downloaded with the getData() function from the raster package. It is also possible to adjust the spatial resolution res=2.5  to 30 seconds, 5 minutes and 10 minutes.

```{r}
currentEnv1=getData("worldclim", var="bio", res=10)
```

The other environmental datasets that we used are the new ENVIREM variables that give additional climatic information to the Bioclim datasets. We used median elevation variables from the Harmonized World Soil Database (HWSD) which are based on NASA’s Shuttle Radar Topographic Mission to calculate worldwide slope and aspect. We used indirect height measures such as slope and aspect because the height variables are directly correlated with the temperature Bioclim datasets. To capture soil characteristics, we used organic carbon, pH CaCL, bulk density and clay percentage datasets obtained from the land-atmosphere interaction research group at Sun Yat-sen University. 

The additional environmental datasets that we used for this research can be downloaded from our dropbox folder at a spatial resolution of 5 and 10 minutes. 

```{r}
soilproperties<-stack("C:/Users/elkeh/Dropbox/trait-geo-diverse-ungulates/Input_Datasets/Abiotic_Data/10_deg/Totalstack.tif")
currentEnv<- stack(soilproperties, currentEnv1)
```

The occurrence datasets are needed to extract useful environmental information per species. The line below downloads a list of the species of interest from the github (https://github.com/naturalis/trait-geo-diverse-ungulates) data folder, originally obtained via GBIF. The data contains the taxon name, taxon id and the longitude and latitude. 

```{r}
t<-read.table("https://github.com/naturalis/trait-geo-diverse-ungulates/raw/master/data/filtered/taxa.txt", header = FALSE, sep = "", dec = ".")
```

Below an example of how to plot these occurece datasets is given. 

```{r, message=FALSE, results='hide',fig.keep='last', warning=FALSE}
# here you select the file in the list that you want to plot
file<-paste("https://github.com/naturalis/trait-geo-diverse-ungulates/raw/master/data/filtered/", t[5,1], sep = "")
species_occurence<-read.csv(file)
colnames(species_occurence) <- c("taxon_id","taxon_name","decimal_latitude","decimal_longitude")
# plot a simple world map
data(wrld_simpl)
plot(wrld_simpl, axes=TRUE, xlim=c(min(species_occurence$decimal_longitude)-5,max(species_occurence$decimal_longitude)+5), ylim=c(min(species_occurence$decimal_latitude)-5,max(species_occurence$decimal_latitude)+5), fill=TRUE, col="grey", main= "Occurence points")
points(species_occurence$decimal_longitude, species_occurence$decimal_latitude, col="orange", pch=20, cex=0.75)
box()
```


# Maxent: species distribution model  
=============================
For this research we used the Maximum Entropy (MaxEnt) machine learning algorithm version 3.3.3 to construct SDMs for the 156 remaining species. Previous research has demonstrated that the MaxEnt technique performs well when using presence only data to estimate the relationships between environmental predictors and the occurrences of species (Elith et al., 2011, Philips et al., 2006, Tognelli et al., 2009, Conolly et al., 2012). The widely used machine learning algorithm is very efficient in the complex handling of response and predictor variable interactions and works well with little occurrence data points (Elith et al., 2011, Elith et al., 2006, Wisz et al., 2008).

Before the construction of the maxent model the environmental rasters are cropped to the extent of the occurrence points for a specific species + a buffer around the total extent. Buffers that are too small can result in underestimations of edge effects while buffer that are to large have the risk of losing track of favorable environmental conditions due to noise. In this research we base the extent of the buffer on  the maximum distribution between two occurrence points, in this way we account for species with a wide distribution and species with a small distribution. The cropped environmental data are checked for collinearity, because only uncorrelated environmental raster layers can be used in the SDM (Dormann et al., 2013, Reas & Aguirre-Gutierrez, 2018). To remove correlated layers the removeCollinearity function in the virtualspecies version 1.4-4 R package was used (Leroy et al., 2016). Environmental variables with a Pearson’s R correlation coefficients above 0.7 were grouped and one variable within this group was randomly chosen, resulting in a raster stack with only uncorrelated environmental rasters. 

Afterwards the occurrence dataset is split in k-fold partitions: a training dataset containing 75% of the data and a test dataset containing 25% of the data. The maxent model is constructed using the maxent function from the dismo R package (Hijmans & Elith, 2013). The function extracts abiotic environmental data for the training occurrence locations and 1000 random sampled background locations, resulting in a model maxent object that can be used to predict which other locations are suitable. 

To assess the model performance we used the area under the receiver operating curve (ROC), also known as the AUC, which is often used to estimate the ability of models (Fourcade et al., 2014). The AUC was interpreted as the probability that a randomly chosen “presence point”, the location of a species occurrence, has a higher predicted probability of occurrence than a randomly chosen absence point (Reas & Aguirre-Gutierrez, 2018). To compare a presence point to an absence point 1000 absence points were randomly sampled within the study area. The test occurence datasets were used to evaluate the model performance with the evaluate function in the dismo R package (Hijmans & Elith, 2013). Only SDMs with an AUC value higher than 0.7 were used in the further steps, since these models are generally accepted as useful models (Swets et al., 2000). 

The script below shows a loop that automatically loops through each species in the list and seperates them into two groups (i) the models with a high accuracy and (ii) the models with a low accuracy. The Maxent_function used in this loop can be viewed and adapted in our Github depository (https://github.com/naturalis/trait-geo-diverse-ungulates/blob/master/script/MaxEnt_function.R). 


```{r echo=FALSE}
source("https://github.com/naturalis/trait-geo-diverse-ungulates/raw/master/script/MaxEnt_function.R")
```

```{r, message=FALSE, results='hide',fig.keep='last', warning=FALSE}
# first we created two empty lists, one list for models with a low accuracy (AUC below 0.7) and one list for models with a high accurecy (AUC above 0.7)


list_species_model_low_accuracy<- list()
list_species_model_high_accuracy<- list()
for (i in 1:10){

# set the extent for the training model with a buffer of 5 lon and lat
file<-paste("https://github.com/naturalis/trait-geo-diverse-ungulates/raw/master/data/filtered/", t[i,1], sep = "")
species_occurence<-read.csv(file)
colnames(species_occurence) <- c("taxon_id","taxon_name","decimal_latitude","decimal_longitude")
i
species_model<- Maxent_fuction(species_occurence, currentEnv)

# validate the model with the test data
# to construct an AUC model we need random points
random<- randomPoints(species_model[[2]], 1000)
Validation_species<- evaluate(p=species_model[[3]], a=random, x=species_model[[2]], model =species_model[[1]])

# create two stacks one with the models with a low accuracy <0.7 and one with a high accuracy >0.7
name <- paste(t[i,1])
if (Validation_species@auc > 0.7) list_species_model_high_accuracy[[name]] <- species_model[[1]] else list_species_model_low_accuracy[[name]] <- species_model[[1]]
}
```

The models are now stacked in a list but can be viewed and examined as follows:

```{r, message=FALSE, results='hide', warning=FALSE}
# Select the first model in the list
open_species_model<-list_species_model_high_accuracy[[1]]
# name of the dataset plotted
probeernaam<- names(list_species_model_high_accuracy[1])
name<- paste("Variable importance for", probeernaam)
# plot the variable importance
plot(open_species_model, main = name)
# plot the response curve to see what the range of important values is per abiotic dataset
response(open_species_model)
```

The outcome of the species distribution models can be used to create a prediction of the areas that are suitable for the species. The script below shows a loop that creates prediction raster files for the models with a high prediction accuracy.

```{r, message=FALSE, results='hide', warning=FALSE, fig.keep='last'}
## Model predictions
prediction_rasters <- stack()
for (i in 1:length(list_species_model_high_accuracy)){
open_species_model<-list_species_model_high_accuracy[[i]]
#select non correlated layers from model environment in the world environment
noncorrelated<- names(list_species_model_high_accuracy[[i]]@presence)
subsetworldEnv<- subset(currentEnv,c(noncorrelated))

# make prediction of the whole earth based on the maxent SDM
species.pred<- predict(open_species_model, subsetworldEnv)
prediction_rasters<- stack(prediction_rasters, species.pred)
}

names(prediction_rasters)<- names(list_species_model_high_accuracy)
plot(prediction_rasters)

```

To assess whether the predicted suitable niche spaces differ per species we calculate their niche overlap. We used Schoener’s D to calculate niche overlap since it has been suggested to be the best suited index for maxent SDM outputs (Rödder & Engler, 2011). The index ranges from 0 which is no overlap to 1 which is a complete overlap and is based on the model prediction maps. 

```{r, message=FALSE, warning=FALSE}
# calculate niche overlap
overlap<- calc.niche.overlap(prediction_rasters, stat="D", maxent.args )

# create a distance matrix
m<-as.dist(1-overlap)

# plot an unrooted dendrogram
d<-nj(m)
plot(d, type="unrooted", cex = 0.1, main= "Unrooted dendrogram")

# plot a circular fan dendrogram
cl<- hclust(m)
colors = c("red", "blue", "green", "black", "orange", "grey")
clus4 = cutree(cl, 3)
plot(as.phylo(cl), type = "fan", tip.color = colors[clus4],
     label.offset = 0.1, cex = 0.7, main = "Fan dendrogram")

```

# Outlying Mean Index (OMI)
=============================
The second approach we used to characterize environmental niches per species is the Outlying Mean Index (OMI) proposed by Dolec et al. (2000). The OMI is a multivariate method that measures the distance of the niche per species to the mean environmental conditions of the study area. The difference in distance is used to estimate niche position and breadth (Doledec et al., 2000). 

```{r, message=FALSE, warning=FALSE}
## transform the environmental raster datasets to spatialpixelsdataframes
rtoAsc<- as(currentEnv, "SpatialPixelsDataFrame")
proj4string(rtoAsc) <- CRS("+proj=longlat +datum=WGS84")

### make a spatialPointsDataFrame from all the seperate species 
## create empty spatialpointsdataframe 

spdf<-new("SpatialPointsDataFrame",                                                          
    coords = structure(numeric(0), .Dim = c(0L, 2L),                          
                       .Dimnames = list(NULL, c("decimal_longitude", "decimal_latitude"))),  
    bbox = structure(c(1, 1, 1, 1), .Dim = c(2L, 2L),                         
                     .Dimnames = list(c("decimal_longitude", "decimal_latitude"),
                                      c("min", "max"))),
    proj4string = new("CRS", projargs = "+proj=longlat +datum=WGS84")) 

for (i in 1:153){
    file<-paste("https://github.com/naturalis/trait-geo-diverse-ungulates/raw/master/data/filtered/", t[i,1], sep = "")
  species_occurence<-as.matrix(read.csv(file))
  name<- paste(t[i,1])
  length_df<- NROW(species_occurence)
  bindlonglat<- as.data.frame(cbind(species_occurence[, c("decimal_longitude", "decimal_latitude")]))
  points<- bindlonglat
  points$decimal_longitude<- as.numeric(as.character(points$decimal_longitude))
  points$decimal_latitude<- as.numeric(as.character(points$decimal_latitude))
  coordinates(points)<- ~ decimal_longitude + decimal_latitude
  spdf2<- SpatialPointsDataFrame(points, data.frame(species = rep(name, length_df)), proj4string = CRS)
  proj4string(spdf2) <- CRS("+proj=longlat +datum=WGS84")
  spdf<- rbind(spdf, spdf2)
}
```

The environmental spatialpixeldataframes and the spatialpointsdataframes are used to create a dataframe with all the environmental variability in our dataset (world). The occurence datasets are used to create a dataframe that shows which species visited which spatialpixel in the environmental dataframe. 

```{r, message=FALSE, warning=FALSE}
cp <- count.points(spdf, rtoAsc)

dfavail <- slot(rtoAsc, "data")
dfavail <- tibble::rowid_to_column(dfavail, "ID")
dfavail<- na.omit(dfavail)

dfused <- slot(cp, "data")
dfused <- tibble::rowid_to_column(dfused, "ID")

dfused<- subset(dfused, dfused$ID %in% dfavail$ID )
dfused <- subset(dfused, select = -ID )
```

A PCA analysis is conducted to standardize all the environmental variables. This standardized dataframe is used a an input dataset for the niche function to calculate the OMI per species. The OMI is used to plot both niche breadth and niche position per species. 

```{r, message=FALSE, warning=FALSE}

## pca to analyse the environmental data 
## standardizes the environmental variables 
## the OMI uses these standardized values 
dud<- dudi.pca(dfavail[2:42], scannf=FALSE)
#scatter(dud, npcs=2)

# The correlations between environmental variables and PCA axes:
dud$co

## Calculate OMI based on the standardized environmental variables per occurece point
nic<- niche(dud, dfused, scannf=FALSE)

# OMI values 
niche.param(nic)


## This dataframe shows the averages per species for the standardized environmental variables
p<-nic$tab


# plot the differences per dataset for domesticated and wild ungulates

# 1 = domesticated 
# 0 = wild

df.melt<-melt(df_selection, id.var=c("domestic", "X"))

P<- ggplot(data = df.melt, aes(x=variable, y=value)) + geom_boxplot(aes(fill=as.factor(domestic)), outlier.shape=NA, position="dodge") + theme(strip.background = element_blank(), 
                                                                                                                                           panel.grid = element_blank(),
                                                                                                                                           axis.line = element_line(colour = "black"),
                                                                                                                                           panel.background = element_blank())+
  ylim(-2, 4)+
  ylab("Standardized values") +xlab("")+
  guides(fill=guide_legend(title="Wild vs Domesticated"))+
  scale_fill_manual(values=c("orange", "tomato"), 
                    breaks=c("0", "1"),
                    labels=c("Wild Ungulates", "Domesticated Ungulates"))+
                     theme(axis.text.x = element_text(angle = 90, hjust = 1))

# Use only p.format as label. Remove method name.
P + stat_compare_means(label = "p.format", aes(group = domestic))

## plot niche position and breadth per species 
## niche position of each species based on OMI values 
# ls = sites coordinates
sco.distri(nic$ls[,1],dfused,clab=0.7) #Niche postition and breadth based on OMI axis 1
sco.distri(nic$ls[,2],dfused,clab=0.7) #Niche postition and breadth based on OMI axis 2
```

