---
title: "Niche Traits"
author: "Rutger Vos (@rvosa)"
date: "27-2-2019"
output: html_document
---

Load the required libraries:

```{r load_libs}
library(phytools, quietly = T)
source('Data.R')
```

Initialize global variables:

```{r globals}
REPO_HOME <- paste(getwd(),'/../',sep='')
```

Load the list of taxa:

```{r taxa}
taxa.names <- scan(paste(REPO_HOME, "/data/filtered/taxa.txt", sep = ""), sep = "\n", what = character())
```

Define the list of GIS layers, i.e. the traits:

```{r layers}
data.layers <- get_layers(REPO_HOME, data.res = 10)
layers.names <- names(data.layers)

# coerce layers to SpatialPixelsDataFrame with WGS84 coordinate reference system
data.layers.spdf <- as(data.layers, "SpatialPixelsDataFrame")
proj4string(data.layers.spdf) <- CRS("+proj=longlat +datum=WGS84")
```

Populate a data.frame of taxa x traits and record the contribution of each of these traits:

```{r models}

# instantiate variable contributions frame from a matrix of taxa x layers
traits.contributions <- data.frame(matrix(
  nrow = length(taxa.names), 
  ncol = length(layers.names), 
  dimnames = list(taxa.names,layers.names))
)

# start iterating over taxa
for ( i in 1:length(taxa.names) ) {
  
  # load maxent model if it exists
  maxent.model <- get_maxent_model( REPO_HOME, taxa.names[i] )
  if (!is.null(maxent.model)) {
    
    # the plot function returns a named list with the variable contributions
    var.contrib <- plot(maxent.model)
      
    # iterate over layers, store variable contribution
    for ( j in 1:length(layers.names) ) {
      if ( layers.names[j] %in% colnames(maxent.model@presence) ) {
        traits.contributions[i,j] <- var.contrib[layers.names[j]]
      }
    }
  }
}

```

Now let's summarize the variable importance:

```{r contributions}

# make a box plot. as a side effect, the summary statistics are returned
traits.contributions.summary <- boxplot.default(traits.contributions, varwidth = T, outline = F)

# we will populate a data frame with the returned summary statistics
traits.contributions.df <- data.frame(matrix(
  nrow = length(layers.names), 
  ncol = 2, 
  dimnames = list(layers.names,c("mean","n")))
)
for ( i in 1:length(traits.contributions.summary$names) ) {
  traits.contributions.df[i,1] <- traits.contributions.summary$stats[i*5-2]
  traits.contributions.df[i,2] <- traits.contributions.summary$n[i]
}
```

We are going to look at the trait means as predictor variables for domestication, so 
we create a data frame with domestication as a state:

```{r domestication}
# instantiate data frame from a matrix of taxa x layers
traits.means <- data.frame(matrix(
  nrow = length(taxa.names), 
  ncol = length(layers.names) + 1, 
  dimnames = list(taxa.names,c("IsDomesticated",layers.names)))
)

# vector of all domesticated taxa
dom.taxa <- c(
  "Bos_frontalis_gaurus", "Bos_grunniens_mutus", "Bos_javanicus", "Bos_taurus_primigenius",
 	"Bubalus_bubalis_arnee", "Camelus_bactrianus", "Camelus_dromedarius", "Capra_hircus_aegagrus",
 	"Equus_przewalskii", "Equus_africanus", "Lama_glama_guanicoe", "Ovis_aries_orientalis",
 	"Rangifer_tarandus", "Sus_scrofa", "Vicagna_vicugna"
)

# iterate over taxa
for ( i in 1:length(taxa.names) ) {
  taxon.name <- taxa.names[i]
  message(taxon.name)
  
  # store whether this taxon is domesticated
  if ( taxon.name %in% dom.taxa ) {
    traits.means[i,1] <- T
  } else {
    traits.means[i,1] <- F
  }
  
  # read occurrences, create df with numeric coordinates
  taxon.occ <- get_occurrences(REPO_HOME,taxon.name)
  taxon.coord <- as.data.frame(cbind(taxon.occ[, c("decimal_longitude", "decimal_latitude")]))
  taxon.coord$decimal_longitude <- as.numeric(as.character(taxon.coord$decimal_longitude))
  taxon.coord$decimal_latitude <- as.numeric(as.character(taxon.coord$decimal_latitude))  
  
  # extract data, store in mean values
  taxon.values <- extract(data.layers, taxon.coord, df = T, fun = 'mean')
  for ( j in 1:length(layers.names) ) {
    layer.name <- layers.names[j] 
    traits.means[taxon.name,layer.name] <- mean(taxon.values[,layer.name], na.rm = T)
  }  
}
```
