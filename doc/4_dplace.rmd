---
title: "D-PLACE"
author: "Rutger Vos (@rvosa)"
date: "14-3-2019"
output: html_document
---

### Set up variables

```{r preamble}
library(dplyr)
library(ape)

# XXX set working directory to script source first
REPO_HOME <- paste(getwd(), "/../", sep = "")
```

### Domestic animals (SCCS)

The Standard Cross-Cultural Sample (SCCS) is a database that records many
variables across societies. Thanks to [D-PLACE](https://d-place.org), these
data are easily available and integrated with phylogenies of cultural evolution.

| *Species*                                                         | *Cluster* | *SCCS code*                                                            |
|-------------------------------------------------------------------|-----------|------------------------------------------------------------------------|
| _Capra hircus aegagrus_                                           | 7         | [1486. GOATS PRESENT](https://d-place.org/parameters/SCCS1486)         |
| _Ovis aries orientalis_                                           | 5         | [1487. SHEEP PRESENT](https://d-place.org/parameters/SCCS1487)         |
| _Sus scrofa_                                                      | 14        | [1488. PIGS PRESENT](https://d-place.org/parameters/SCCS1488)          |
| _Lama glama guanicoe_, _Vicagna vicugna_                          | 5, 5      | [1521. LLAMA PRESENT](https://d-place.org/parameters/SCCS1521)         |
| _Bubalus bubalis arnee_                                           | 2         | [1520. BUFFALO PRESENT](https://d-place.org/parameters/SCCS1520)       |
| _Bos grunniens mutus_                                             | 7         | [1519. YAKS PRESENT](https://d-place.org/parameters/SCCS1519)          |
| _Rangifer tarandus_                                               | 26        | [1518. REINDEER PRESENT](https://d-place.org/parameters/SCCS1518)      |
| _Camelus bactrianus_, _Camelus dromedarius_                       | 7, 7      | [1517. CAMELS PRESENT](https://d-place.org/parameters/SCCS1517)        |
| _Equus africanus_                                                 | NA        | [1516. DONKEYS/MULES PRESENT](https://d-place.org/parameters/SCCS1516) |
| _Equus przewalskii_                                               | 7         | [1515. HORSES PRESENT](https://d-place.org/parameters/SCCS1515)        |
| _Bos frontalis gaurus_, _Bos javanicus_, _Bos taurus primigenius_ | 2, 5, 5   | [1514. CATTLE PRESENT](https://d-place.org/parameters/SCCS1514)        |

```{r domestic_interactions}
# mapping from data set to taxa
sccs.code <- list(
  SCCS1486 = c('Capra_hircus_aegagrus'),
  SCCS1487 = c('Ovis_aries_orientalis'),
  SCCS1488 = c('Sus_scrofa'),
  SCCS1521 = c('Lama_glama_guanicoe', 'Vicagna_vicugna'),
  SCCS1520 = c('Bubalus_bubalis_arnee'),
  SCCS1519 = c('Bos_grunniens_mutus'),
  SCCS1518 = c('Rangifer_tarandus'),
  SCCS1517 = c('Camelus_bactrianus', 'Camelus_dromedarius'),
  SCCS1516 = c('Equus_africanus'),
  SCCS1515 = c('Equus_przewalskii'),
  SCCS1514 = c('Bos_frontalis_gaurus', 'Bos_javanicus', 'Bos_taurus_primigenius')
)

# containers to hold full data; list of rows; list of columns
animal.present <- list()
societies <- c()
dom.taxa <- c()

# iterate over society codes
for ( sc in names(sccs.code) ) {
  
  # load CSV file
  sccs.file <- sprintf('%s/data/d-place/%s.csv',REPO_HOME,sc)
  animal.present[[sc]] <- select(
    read.table(
      sccs.file, 
      header = T, 
      sep = ',', 
      quote = "\""
    ),
    language_glottocode,
    code
  )
  
  # grown lists of rows and columns
  societies <- c(societies, as.character(animal.present[[sc]]$language_glottocode))
  dom.taxa <- c(dom.taxa, sccs.code[[sc]])
}
societies <- unique(societies)

# create and populate matrix
animal.present.matrix <- matrix(
  nrow = length(societies), 
  ncol = length(dom.taxa),
  dimnames = list(societies,dom.taxa)
)
for ( sc in names(sccs.code) ) {
  taxa <- sccs.code[[sc]]
  for ( i in 1:length(animal.present[[sc]]$language_glottocode) ) {
    record <- animal.present[[sc]][i,]
    socid <- as.character(record$language_glottocode)
    for ( taxon in taxa ) {
      animal.present.matrix[socid,taxon] <- record$code
    }
  }
}
animal.present.df <- as.data.frame(animal.present.matrix)
animal.present.df$language_glottocode <- row.names(animal.present.df)
```

### Demographics (SCCS)

We interpret niche cluster 7 as a less productive, drier environment. Hence, 
these have relatively low population densities. We read data sets:

- Population Density (from Pryor Data) [SCCS1130](https://d-place.org/parameters/SCCS1130)
- Scale 8- Density of Population [SCCS156](https://d-place.org/parameters/SCCS156)

```{r pop_density}
# generic function to load single SCCS tabls
read.sccs.variable <- function(sccs.code) {
  sccs.file <- sprintf('%s/data/d-place/%s.csv',REPO_HOME,sccs.code)
  sccs.matrix <- select(
    read.table(
      sccs.file, 
      header = T, 
      sep = ',', 
      quote = "\"",
      as.is = c('language_glottocode')
    ),
    language_glottocode,
    code
  )
  sccs.df <- as.data.frame(sccs.matrix)
  row.names(sccs.df) <- sccs.df$language_glottocode
  names(sccs.df) <- c('language_glottocode',sccs.code)
  return(sccs.df)
}

pop.density.SCCS156 <- read.sccs.variable('SCCS156')
pop.density.SCCS1130 <- read.sccs.variable('SCCS1130')
```

### Sedentism (SCCS)

We interpret niche cluster 5 as more productive, and therefore more conducive
to sedentism. We download the following data set:

- Scale 2- Fixity of Residence [SCCS150](https://d-place.org/parameters/SCCS150)

```{r sedentism}
sedentism.SCCS150 <- read.sccs.variable('SCCS150')
```

### Despotism (SCCS)

Sedentary societies with high population densities should be conducive to local
despotism. We download the following data sets:

- Despotic Bias in Conflict Resolution [SCCS1134](https://d-place.org/parameters/SCCS1134)
- Scale 10- Social Stratification [SCCS158](https://d-place.org/parameters/SCCS158)

```{r despotism}
despotism.SCCS1134 <- read.sccs.variable('SCCS1134')
despotism.SCCS158 <- read.sccs.variable('SCCS158')
```

### Join data

We left-join the different data frames on the `language_glottocode` columns:

```{r leftjoin}
# join population densities
joined.df <- dplyr::left_join(animal.present.df, pop.density.SCCS1130)
joined.df <- dplyr::left_join(joined.df, pop.density.SCCS156)

# join sedentism
joined.df <- dplyr::left_join(joined.df, sedentism.SCCS150)

# join despotism
joined.df <- dplyr::left_join(joined.df, despotism.SCCS1134)
joined.df <- dplyr::left_join(joined.df, despotism.SCCS158)

# assign row names
row.names(joined.df) <- joined.df$language_glottocode

# define clusters
taxa.cluster7 <- c(
  'Capra_hircus_aegagrus',
  'Camelus_bactrianus', 
  'Camelus_dromedarius',
  'Equus_przewalskii',
  'Bos_grunniens_mutus'
)
taxa.cluster5 <- c(
  'Ovis_aries_orientalis',
  'Lama_glama_guanicoe', 
  'Vicagna_vicugna',
  'Bos_javanicus',
  'Bos_taurus_primigenius'
)

# create and populate matrix
summarized.matrix <- matrix(
  nrow = length(societies), 
  ncol = 3,
  dimnames = list(societies,c('taxa.cluster7','taxa.cluster5','clusters'))
)
for ( soc in societies ) {
  tc7 <- sum(joined.df[soc,taxa.cluster7], na.rm = T)
  summarized.matrix[soc,'taxa.cluster7'] <- tc7
  
  tc5 <- sum(joined.df[soc,taxa.cluster5], na.rm = T)
  summarized.matrix[soc,'taxa.cluster5'] <- tc5
  
  if ( tc5 == 0 & tc7 == 0 ) {
    summarized.matrix[soc,'clusters'] <- 0 # no livestock
  }
  if ( tc5 != 0 & tc7 == 0 ) {
    summarized.matrix[soc,'clusters'] <- 2 # sedentary livestock
  }
  if ( tc5 == 0 & tc7 != 0 ) {
    summarized.matrix[soc,'clusters'] <- 1 # roaming livestock
  }
  if ( tc5 != 0 & tc7 != 0 ) {
    summarized.matrix[soc,'clusters'] <- 3 # both
  }  
}
summarized.df <- as.data.frame(summarized.matrix)
summarized.df$language_glottocode <- row.names(summarized.df)
joined.df <- left_join(joined.df,summarized.df)
```