---
title: "D-PLACE"
author: "Rutger Vos (@rvosa)"
date: "14-3-2019"
output: html_document
---

### Set up environment

```{r preamble}
library(dplyr)
library(ape)
library(geiger)
library(circlize)

# XXX set working directory to script source first
REPO_HOME <- paste(getwd(), "/../", sep = "")

# generic function to load single SCCS tabls
read.sccs.variable <- function(sccs.code) {
  sccs.file <- sprintf('%s/data/d-place/%s.csv',REPO_HOME,sccs.code)
  sccs.matrix <- select(
    read.table( sccs.file, header = T, sep = ',', quote = "\"" ),
    language_glottocode,
    code
  )
  sccs.df <- as.data.frame(sccs.matrix)
  row.names(sccs.df) <- sccs.df$language_glottocode
  names(sccs.df) <- c('language_glottocode',sccs.code)
  return(sccs.df)
}
```

### Domestic animals (SCCS)

The Standard Cross-Cultural Sample (SCCS) is a database that records many
variables across societies. Thanks to [D-PLACE](https://d-place.org), these
data are easily available and integrated with phylogenies of cultural evolution.

| *Species*                                                         | *Cluster* | *SCCS code*                                                            |
|-------------------------------------------------------------------|-----------|------------------------------------------------------------------------|
| _Capra hircus aegagrus_                                           | 7         | [1486. GOATS PRESENT](https://d-place.org/parameters/SCCS1486)         |
| _Ovis aries orientalis_                                           | 5         | [1487. SHEEP PRESENT](https://d-place.org/parameters/SCCS1487)         |
| _Sus scrofa_                                                      | 14        | [1488. PIGS PRESENT](https://d-place.org/parameters/SCCS1488)          |
| _Lama glama guanicoe_, _Vicagna vicugna_                          | 5, 5      | [1521. LLAMA PRESENT](https://d-place.org/parameters/SCCS1521)         |
| _Bubalus bubalis arnee_                                           | 2         | [1520. BUFFALO PRESENT](https://d-place.org/parameters/SCCS1520)       |
| _Bos grunniens mutus_                                             | 7         | [1519. YAKS PRESENT](https://d-place.org/parameters/SCCS1519)          |
| _Rangifer tarandus_                                               | 26        | [1518. REINDEER PRESENT](https://d-place.org/parameters/SCCS1518)      |
| _Camelus bactrianus_, _Camelus dromedarius_                       | 7, 7      | [1517. CAMELS PRESENT](https://d-place.org/parameters/SCCS1517)        |
| _Equus africanus_                                                 | NA        | [1516. DONKEYS/MULES PRESENT](https://d-place.org/parameters/SCCS1516) |
| _Equus przewalskii_                                               | 7         | [1515. HORSES PRESENT](https://d-place.org/parameters/SCCS1515)        |
| _Bos frontalis gaurus_, _Bos javanicus_, _Bos taurus primigenius_ | 2, 5, 5   | [1514. CATTLE PRESENT](https://d-place.org/parameters/SCCS1514)        |

```{r domestic_interactions}
# mapping from data set to taxa
sccs.code <- list(
  SCCS1486 = c('Capra_hircus_aegagrus'),
  SCCS1487 = c('Ovis_aries_orientalis'),
  SCCS1488 = c('Sus_scrofa'),
  SCCS1521 = c('Lama_glama_guanicoe', 'Vicagna_vicugna'),
  SCCS1520 = c('Bubalus_bubalis_arnee'),
  SCCS1519 = c('Bos_grunniens_mutus'),
  SCCS1518 = c('Rangifer_tarandus'),
  SCCS1517 = c('Camelus_bactrianus', 'Camelus_dromedarius'),
  SCCS1516 = c('Equus_africanus'),
  SCCS1515 = c('Equus_przewalskii'),
  SCCS1514 = c('Bos_frontalis_gaurus', 'Bos_javanicus', 'Bos_taurus_primigenius')
)

animal.present.df <- data.frame( language_glottocode = character())
for ( sc in names(sccs.code) ) {
  temp.df <- read.sccs.variable(sc)
  
  # copy values over to all taxa
  values <- temp.df[,2]
  for ( taxon in sccs.code[[sc]] ) {
    temp.df[[taxon]] <- values
  }
  rm(values, taxon) # clean
  
  # subset to remove opaque identifier column header
  temp.df <- temp.df[,c('language_glottocode',sccs.code[[sc]])]
  
  # do an outer join on the glottocodes, avoid coercion warning
  temp.df$language_glottocode <- as.character(temp.df$language_glottocode)
  animal.present.df <- full_join(animal.present.df, temp.df, by = c('language_glottocode'))
  rm(temp.df) # clean
}
rm(sc) # clean
```

### Demographics (SCCS)

We interpret niche cluster 7 as a less productive, drier environment. Hence, 
these have relatively low population densities. We read these data:

- Population Density (from Pryor Data) [SCCS1130](https://d-place.org/parameters/SCCS1130)
	2. less than 1 per square mile (n=51), `low`
	3. 1-4.9 per square mile (n=28), `high`
	4. 5-24.9 per square mile (n=35), `high`
	5. 25-99.9 per square mile (n=37), `high`
	6. 99-499.9 per square mile (n=24), `high`
	7. 500 or more per square mile (n=11), `high`


```{r pop_density}
# update column names after loading
pop.density.SCCS1130 <- read.sccs.variable('SCCS1130')
names(pop.density.SCCS1130) <- c('language_glottocode', 'pop.density.SCCS1130')

# split in low and high density subsets
smallpop <- filter(pop.density.SCCS1130, pop.density.SCCS1130 == 2)
smallpop$pop.density <- 'low'
bigpop <- filter(pop.density.SCCS1130, pop.density.SCCS1130 > 2)
bigpop$pop.density <- 'high'

# concatenate into new data frame
pop.density.SCCS1130 <- data.frame(
  language_glottocode = c(
    as.character(smallpop$language_glottocode),
    as.character(bigpop$language_glottocode)
  ),
  pop.density.SCCS1130 = c(
    smallpop$pop.density,
    bigpop$pop.density
  )
)
rm(smallpop,bigpop)
plot(pop.density.SCCS1130$pop.density.SCCS1130, main = "Population density")
```

### Sedentism (SCCS)

We interpret niche cluster 5 as more productive, and therefore more conducive
to sedentism. We download the following data set:

- Scale 2 - Fixity of Residence [SCCS150](https://d-place.org/parameters/SCCS150)

The data is ordinal, with the following values:

1. Nomadic (n=28)
2. Seminomadic (n=21)
3. Semisedentary (n=20)
4. Sedentary; impermanent (n=15)
5. Sedentary (n=102)

We will lump the first four states together and contrast those with the only
fully sedentary state.

```{r sedentism}
sedentism.SCCS150 <- read.sccs.variable('SCCS150')

# make a subframe with all records that are not truly sedentary (i.e. anything
# below 3), and assign these the string value 'impermanent'
sedentism.SCCS150.nomadic <- filter(sedentism.SCCS150, SCCS150 < 3)
sedentism.SCCS150.nomadic$SCCS150 <- "impermanent"

# make a subframe with only those records that are truly sedentary (i.e. value
# is > 2), and assign these the string value 'sedentary'
sedentism.SCCS150.sedentary <- filter(sedentism.SCCS150, SCCS150 > 2)
sedentism.SCCS150.sedentary$SCCS150 <- "sedentary"

# concatenate the subframes into a new frame. Don't turn strings into factors
# just yet so that the glottocodes continue to be strings, then coerce the
# sedentary/impermanent states to factors.
sedentism.SCCS150 <- data.frame( 
  language_glottocode = c( 
    as.character(sedentism.SCCS150.nomadic$language_glottocode), 
    as.character(sedentism.SCCS150.sedentary$language_glottocode) 
  ), 
  sedentism.SCCS150 = c(
    sedentism.SCCS150.nomadic$SCCS150,
    sedentism.SCCS150.sedentary$SCCS150
  )
)

# clean up namespace, free memory
rm(sedentism.SCCS150.nomadic, sedentism.SCCS150.sedentary)
plot(sedentism.SCCS150$sedentism.SCCS150, main = "Fixity of residence")
```

### Stratification (SCCS)

Sedentary societies with high population densities should be conducive to local
stratification. We download the following data:

- Scale 10 - Social Stratification [SCCS158](https://d-place.org/parameters/SCCS158),
  which is ordinal and has the following levels:
  1. Egalitarian (n=65), `egalitarian`
  2. Hereditary slavery	(n=52), `stratified`
  3. 2 social classes, no castes/slavery (n=19), `stratified`
  4. 2 social classes, castes/slavery (n=20), `stratified`
  5. 3 social classes or castes, w/ or w/out slavery (n=30), `stratified`

```{r despotism}
stratification.SCCS158 <- read.sccs.variable('SCCS158')

# make a subframe only with records that are truly egalitarian
# and assign these the string (i.e. factor) value 'egalitarian'
stratification.SCCS158.egalitarian <- filter(
  stratification.SCCS158,
  SCCS158 < 2
)
stratification.SCCS158.egalitarian$SCCS158 <- "egalitarian"

# make a subframe with all records that are not truly egalitarian (values 2..5),
# and assign these the string (i.e. factor) value 'stratified'
stratification.SCCS158.stratified <- filter(
  stratification.SCCS158,
  SCCS158 > 1
)
stratification.SCCS158.stratified$SCCS158 <- "stratified"

# concatenate the subframes into a new frame. Don't make factors here so that
# we keep the glottocodes as strings, but coerce the egalitarian/stratification
# string values afterwards.
stratification.SCCS158 <- data.frame(
  language_glottocode = c(
    as.character(stratification.SCCS158.egalitarian$language_glottocode),
    as.character(stratification.SCCS158.stratified$language_glottocode)
  ),
  stratification.SCCS158 = c(
    stratification.SCCS158.egalitarian$SCCS158,
    stratification.SCCS158.stratified$SCCS158
  )
)

# clean up namespace, free memory
rm(stratification.SCCS158.egalitarian,stratification.SCCS158.stratified)
plot(stratification.SCCS158$stratification.SCCS158, main = "Social stratification")
```

### Join data

We left-join the different data frames on the `language_glottocode` columns:

```{r leftjoin}
# join data sets
joined.df <- dplyr::left_join(pop.density.SCCS1130, sedentism.SCCS150, by=c('language_glottocode'))
joined.df <- dplyr::left_join(joined.df, stratification.SCCS158, by=c('language_glottocode'))

# assign row names
societies <- row.names(joined.df) <- joined.df$language_glottocode

# grouping of domesticated taxa by niche cluster
clusters <- list(
  cluster7 = c(
    'Capra_hircus_aegagrus',
    'Camelus_bactrianus', 
    'Camelus_dromedarius',
    'Equus_przewalskii',
    'Bos_grunniens_mutus'
  ),
  cluster5 = c(
    'Ovis_aries_orientalis',
    'Lama_glama_guanicoe', 
    'Vicagna_vicugna',
    'Bos_javanicus',
    'Bos_taurus_primigenius'
  ),
  cluster2 = c(
    'Bubalus_bubalis_arnee', # 5
    'Bos_frontalis_gaurus'   # 5
  ),
  cluster14 = c('Sus_scrofa'), # 5
  cluster26 = c('Rangifer_tarandus'), # 7
  cluster0 = c('Equus_africanus') # 7
)

# create and populate matrix
summarized.matrix <- matrix(
  nrow = length(animal.present.df$language_glottocode), 
  ncol = length(names(clusters))+1,
  dimnames = list(animal.present.df$language_glottocode,c(names(clusters),'clusters'))
)
row.names(animal.present.df) <- animal.present.df$language_glottocode
for ( soc in animal.present.df$language_glottocode ) {
  for ( cluster in names(clusters) ) {
    taxa <- clusters[[cluster]]
    total <- sum(animal.present.df[soc,taxa],na.rm=T)
    if ( total == 0 ) {
      summarized.matrix[soc,cluster] <- 0
    } else {
      summarized.matrix[soc,cluster] <- 1
    }
  }
}
summarized.df <- as.data.frame(summarized.matrix)
summarized.df$language_glottocode <- row.names(summarized.df)

# filter on steppe/pasture
steppe <- filter(filter(summarized.df, cluster7 == 1 | cluster26 == 1),
                 cluster5 == 0 & cluster2 == 0 & cluster14 == 0)
steppe$clusters <- 'steppe'
pasture <- filter(filter(summarized.df, cluster5 == 1 | cluster2 == 1 | cluster14 == 1),
                  cluster7 == 0 & cluster26 == 0)
pasture$clusters <- 'pasture'
filtered <- data.frame(
  language_glottocode = c(
    steppe$language_glottocode,
    pasture$language_glottocode
  ),
  habitat = c(
    steppe$clusters,
    pasture$clusters
  )
)

joined.df <- dplyr::left_join(filtered,joined.df,by=c('language_glottocode'))

# clean up columns
joined.df <- select(
  joined.df,
  language_glottocode,
  pop.density.SCCS1130,
  sedentism.SCCS150,
  stratification.SCCS158,
  habitat
)
plot(joined.df$habitat)
```

### Load language tree

To correct for Galton's Problem in the comparative analysis of societies we must
correct for their relatedness. For this we use the following tree:

- [Phylogeny Global Classification (Glottolog 3.3)](https://d-place.org/phylogenys/glottolog_global)

```{r tree}
tree.file <- sprintf('%s/data/d-place/glottolog_global.trees',REPO_HOME)
tree <- read.tree( file = tree.file )

# intersection between tree tips and societies in data matrix
societies <- tree$tip.label[
  match(
    joined.df$language_glottocode, 
    tree$tip.label, 
    nomatch = 0
  )
]

# prune tree
tree <- keep.tip(tree, societies)

# prune matrix
row.names(joined.df) <- joined.df$language_glottocode
joined.df <- joined.df[societies,]

plot( tree, show.tip.label = F )
```

### Do multistate analysis

```{r multistate}
clusters <- joined.df$clusters
names(clusters) <- joined.df$language_glottocode
fitARD <- fitDiscrete(multi2di(tree),clusters,model="ARD")
plot(fitARD)
```